<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">

	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	
	<script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js'></script>
	<script type='text/javascript'>
		window.Modernizr || document.write('<script src="modernizr/modernizr.js">\x3C/script>');
	</script>
	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
	<!-- loads if googleapis is not available -->
	<script>if (typeof jQuery === 'undefined') {
	  document.write(unescape("%3Cscript src='jquery/jquery-2.1.4.js' type='text/javascript'%3E%3C/script%3E"));
	}
	</script>

<style>
@keyframes greenToRed {
    0%   {background-color: green;}
    45%  {background-color: green;}
    50%  {background-color: yellow;}
    52%  {background-color: gold;}
    70%  {background-color: gold;}
    75% {background-color: red;}
    77% {background-color: darkred;}
    93% {background-color: darkred;}
    95% {background-color: dodgerblue;}
    100% {background-color: blue;}
}
div#id00C button.btn.btn-primary {
	animation-name: greenToRed;
	animation-duration: 60s;
	-webkit-animation-name: greenToRed;
	-webkit-animation-duration: 60s;
}
</style>

<script type="text/javascript">
"use strict";

var version = '20170701_1214';

// improvements
//     map should not be populated if the MAP div is not visible.  If it is, the road map is never shown. DONE
//     map should include a marker for the named stop (or the gps location)
//     stopLocations should be placed in a separate javascript file.  DONE
//  
//          Home or Office
//                   Home -- Option 1 -- Route, Direction, Letter(E or C or N), StopNumber, StopBefore, StopAfter
//                        --        2 -- 
//                   Office -- Option 1 -- 
//
// to use the url that is stop specific, there is a need to tie into the data updated weekly at: http://datafinder.org/metadata/transit_schedule_google_feed.html
//        a zip file containing
//             routes.txt	route_id
//                          agency_id
//             trips.txt   route_id
//                         trip_id
//                         direction_id (optional)
//             stop_times.txt	trip_id
//                              stop_id
//             stops.txt     stop_id
//                           stop_name
//                           stop_lat
//                           stop_lon
//
//  Workflow of Route -> Direction -> Scheduled Stop  can leave the user confused.  Especially the Route -> Direction step, when NORTHBOUND SOUTHBOUND disappear one row above the "Route - Direction - Stop" button.
//        all are Blue.
//
//  table-responsive added
//
//  Latitude and longitude, how much accuracy is enough?     1 deg latitude at 45degrees is 364604.73335045605 ft.
//                                                           50ft is 1.37e-4 or .000137 degrees
//                                                           1 deg longitude at 45deg    is 258683.22840902332 ft.
//                                                           50ft is 1.93e-4 or .000193 degrees
//
//  reset map is also available as a button above the map graphic
//
function showStop(stopNumber) {
	saveNumberedBusStopInfo(stopNumber);

	var xmlhttp2 = new XMLHttpRequest();
	var url2 = "http://svc.metrotransit.org/NexTrip/" + stopNumber.toString() + "?format=json";
	
	xmlhttp2.onreadystatechange=function() {
		if (xmlhttp2.readyState == 4 && xmlhttp2.status == 200) {
			var myArr = JSON.parse(xmlhttp2.responseText);
			buildStopResults(myArr);
		}
	}
	xmlhttp2.open("GET", url2, true);
	xmlhttp2.send();
}

function saveNumberedBusStopInfo(stopNumber) {
	var activeNumberedBusStopNumber = getDbValue("ActiveNumberedBusStop");
	if(activeNumberedBusStopNumber != null && activeNumberedBusStopNumber.stopNumber == stopNumber) return;
	
	// lookup the stop offsets based on the 
	var oStopNumber = "o" + stopNumber.toString();
	var dbStopNumber = getDbValue(oStopNumber);
	if(dbStopNumber == null) {
		console.log("saveNumberedBusStopInfo(" + stopNumber.toString() + ") caused dbStopNumber to be null. Skipping.");
		console.log("getDbValue(oStopNumber) returned null when oStopNumber=" + oStopNumber);
		return;
	}
	var offsetForStop = JSON.parse(dbStopNumber);
	if(offsetForStop == null) {
		console.log("saveNumberedBusStopInfo(" + stopNumber.toString() + ") caused offsetForStop to be null. Skipping.");
		return;
	}
	console.log("saveNumberedBusStopInfo(" + stopNumber.toString() + ") called, offsetForStop = " + JSON.stringify(offsetForStop));
	
	// offsets have been multiplied by 10,000 and rounded to 0 from these MIN values
	// @lat_min     @lon_min
    // 44.707146	-94.157372
	// stop_id  stop_lat   stop_lon   stop_name
	// 15574    44.912369  -93.252335 Bloomington Ave S & 50th St E
	// 	setDbValue("o15574","{\"n\":2052,\"e\":9050}");
    var latitude = 0.0 + offsetForStop.n/10000.0 + 44.707146;
	var longitude = 0.0 + offsetForStop.e/10000.0 - 94.157372;
	var busStopPoint = {"stopNumber":stopNumber, "latitude": latitude, "longitude": longitude};
	setDbValue("ActiveNumberedBusStop", JSON.stringify(busStopPoint));
	var targetPoint = busStopPoint;
	console.log("saved ActiveNumberedBusStopPoint");
}

function buildStopResults(arr) {
	isCurrentTargetANumberedBusStop = true;

	if(arr == null || arr.length == 0) {
		var element = document.getElementById("id00B");
		element.innerHTML = '<div class="alert alert-warning"><strong>Warning!</strong> Metro Transit does not report any activity at the stop.</div>';
		element.style.display = "block";
		return;
	}

    var i;
//	var out = "<div class=\"table-responsive\"><table class=\"table table-bordered\"><tr class=\"table-row table-header\"><th>Actual</th><th>Route</th><th>Departure</th><th>Banner</th><th>Direction</th><th>Miles</th></tr>";
	var out = "<div class=\"table-responsive\"><table class=\"table table-bordered\"><tr class=\"table-row table-header\"><th>Route</th><th>Departure</th><th>Banner</th><th>Direction</th><th>Miles</th></tr>";
		
    for(i = 0; i < arr.length; i++) {
		out += "<tr><td>" +
		// "</td><td>" +
		((arr[i].BlockNumber == null) ? arr[i].Route + arr[i].Terminal : '<button type="button" class="btn btn-primary btn-md" onclick="busNumberClicked2(' + arr[i].BlockNumber + ', ' + arr[i].Route +')" >' + arr[i].Route + arr[i].Terminal + ' bus:' + arr[i].BlockNumber + '</button>') +
		"</td><td>" +
		arr[i].DepartureText +
		"</td><td>" +
		arr[i].Description +
		"</td><td>" +
		arr[i].RouteDirection +
		"</td><td>" +
		((arr[i].VehicleLatitude == null || arr[i].VehicleLatitude == "0" ) ? "&nbsp;" : distanceInMiles3Digits(arr[i])) +
		"</td></tr>";
    }
    out += "</table></div>"
    document.getElementById("id00B").innerHTML = out;
	document.getElementById("id00B").style.display = "block";
	
}

// to use:     alert("current time is " + new Date().toHHMMSS());
Date.prototype.toHHMMSS = function () {
	// want everything up to the first space
	var timeString = this.toTimeString();
	var spaceAt = timeString.indexOf(" ");
	return timeString.substr(0, spaceAt);
}

function showBusLocation2(route, blockNumber) {
	var xmlhttp8 = new XMLHttpRequest();
	var url8 = "https://svc.metrotransit.org/NexTrip/VehicleLocations/" + route + "?format=json";

	console.log("showBusLocation2(" + route + ", " + blockNumber + ") called.  url8=" + url8);
	
	xmlhttp8.onreadystatechange=function() {
		if (xmlhttp8.readyState == 4 && xmlhttp8.status == 200) {
			populateVehicleLocations2(route, blockNumber, xmlhttp8.responseText);
		}
	}
	xmlhttp8.open("GET", url8, true);
	xmlhttp8.send();
}

function populateVehicleLocations2(route, blockNumber, responseText) {
	var arr = JSON.parse(responseText);
    var i;
    for(i = 0; i < arr.length; i++) {
		// console.log("populateVehicleLocations2: " + arr[i]);
		
		if(arr[i].Route == route && arr[i].BlockNumber == blockNumber) {
			var newValue = "{\"direction\":" + arr[i].Direction + ", \"locationTime\":\"" + arr[i].LocationTime + "\", \"latitude\":" + arr[i].VehicleLatitude + ", \"longitude\":" + arr[i].VehicleLongitude + "}";

			setDbValue("VehicleLocation." + route + "." + blockNumber, newValue);
			console.log("VehicleLocation." + route + "." + blockNumber + "=" + newValue);

			rewriteActualTableData(route, blockNumber);
			return;
		}
		// Object { Bearing: 0, BlockNumber: 1203, Direction: 4, LocationTime: "/Date(1447298877000-0600)/", 
		//          Odometer: 0, Route: "14", Speed: 0, Terminal: "R", 
		//          VehicleLatitude: 44.864286, VehicleLongitude: -93.243361 }
	}
}

var secondsElapsedOffset = 0;
function rewriteActualTableData(route, blockNumber) {
	// nn sec ago:  (up to 100)   n.n min ago:  (up to 5 minutes)
	// miles & direction
	var busLastAt = JSON.parse(getDbValue("VehicleLocation." + route + "." + blockNumber));
	var busLocationTime = fromDateString(busLastAt.locationTime);
	
	addMarker({"route":route, "blockNumber":blockNumber, "time":busLocationTime, "latitude":busLastAt.latitude, "longitude":busLastAt.longitude});
	
	var now = new Date();
	var timezoneOffsetInMinutes = now.getTimezoneOffset();
	var secondsElapsed = (now - busLocationTime.getTime() + (1000 * 60 * timezoneOffsetInMinutes)) / 1000;
	// secondsElapsed should never be less than 0
	//                is an indication that the local clock and the Server clock differ
	//                need to save an offset value.
	if(secondsElapsed < 0 && secondsElapsedOffset < 60) {
		// console.log("secondsElapsedOffset=" + secondsElapsedOffset);
		// console.log("secondsElapsed=" + secondsElapsed);
		secondsElapsedOffset = -secondsElapsed + secondsElapsedOffset;
		// console.log("secondsElapsedOffset=" + secondsElapsedOffset + " adjusted");
	}
	secondsElapsed = secondsElapsed + secondsElapsedOffset;
	
	var s = "";
	if(0 <= secondsElapsed && secondsElapsed < 100) {
		s += secondsElapsed.toFixed(0) + " sec ago";
	}
	else {
		s += (secondsElapsed/60).toFixed(1) + " min ago";
	}
	s += "<br>";

	// ScheduledStop info
	var busAtPoint = {"latitude": busLastAt.latitude, "longitude": busLastAt.longitude};
	var dbRouteDirectionStopActive = getDbValue("RouteDirectionStopActive")
	var activeRouteDirectionStop = null;
	var activeStop = null;
	if(dbRouteDirectionStopActive != null) {
		activeRouteDirectionStop = JSON.parse(dbRouteDirectionStopActive);
		if(activeRouteDirectionStop != null) {
			activeStop = JSON.parse(getDbValue("Stop." + activeRouteDirectionStop.stop));
		}
	}
	
	var busStopPoint = null;
	if((activeStop != null) && (document.getElementById("Actual_" + route + "_" + blockNumber) != null)) {
		busStopPoint =  {"latitude": activeStop.latitude, "longitude": activeStop.longitude};
	} else {
		var activeNumberedBusStopNumber = getDbValue("ActiveNumberedBusStop");
		if(activeNumberedBusStopNumber == null) {
			console.log("rewriteActualTableData(" + route + ", " + blockNumber + ") called, activeNumberedBusStop db value is Null!");
			return;
		}
		// set busStopPoint based on activeNumberedBusStopNumber
		var busStopPoint = JSON.parse(activeNumberedBusStopNumber);
	}

	var milesAway = miles(busAtPoint, busStopPoint);
	
	s += milesAndDirection(milesAway);
	
	// Bus Number
	s += "<br>";
	// s += "bus: " + blockNumber;
	
	s += 'bus: ' + markupBlockNumberButton(blockNumber);
	
	var actualRouteBlockNumber = document.getElementById("Actual_" + route + "_" + blockNumber);
	if(actualRouteBlockNumber != null) {
		actualRouteBlockNumber.innerHTML = s; 
		console.log("Created the busNumberClicked button with blockNumber=" + blockNumber);
	}
}

function markupBlockNumberButton(blockNumber) {
	return '<button type="button" class="btn btn-primary btn-sm" onclick="busNumberClicked(' + blockNumber + ')" >' + blockNumber + '</button>';
}

// like:   "\/Date(1447715700000-0600)\/"
function fromDateString(str) {
    var res = str.match(/\/Date\((\d+)(?:([+-])(\d\d)(\d\d))?\)\//);
    if (res == null)
        return new Date(NaN); // or something that indicates it was not a DateString
    var time = parseInt(res[1], 10);
    if (res[2] && res[3] && res[4]) {
        var dir = res[2] == "+" ? -1 : 1,
            h = parseInt(res[3], 10),
            m = parseInt(res[4], 10);
        time += dir * (h*60+m) * 60000;
    }
    return new Date(time);
}

function selectRoute() {
	// if we already know the routes, saved to localStorage, use that.
	if(Modernizr.localstorage) {
		var p =  getDbValue("Routes");
		if(p != null) {
			populateRoutes(p);
			return;
		}
	}

	var xmlhttp3 = new XMLHttpRequest();
	var url3 = "https://svc.metrotransit.org/NexTrip/Routes?format=json";

	xmlhttp3.onreadystatechange=function() {
		if (xmlhttp3.readyState == 4 && xmlhttp3.status == 200) {
			populateRoutes(xmlhttp3.responseText);
			setDbValue("Routes", xmlhttp3.responseText);
		}
	}
	xmlhttp3.open("GET", url3, true);
	xmlhttp3.send();
}

function populateRoutes(responseText) {
	var arr = JSON.parse(responseText);
    var i;
	var out = '<div id="routeButtonGroup" class="btn-group btn-group-md-1" >';
	var j = 0;
    for(i = 0; i < arr.length; i++) {
		out += '<button type="button" class="btn btn-primary col-md-1" onclick="routeClicked(' + arr[i].Route + ')" >' + arr[i].Route + '</button>';
	}
    out += "</div>";
    document.getElementById("id00RouteDirectionStop").innerHTML = out;
	document.getElementById("id00RouteDirectionStop").style.display = "block";
}

// handle the routeButtonGroup click
$('#routeButtonGroup button').click(function() {
    $(this).addClass('active').siblings().removeClass('active');

	myRoute = $(this).Value;
    // TODO: insert whatever you want to do with $(this) here
});


function busNumberClicked2(blockNumber, routeNumber) {
	console.log("busNumberClicked2(" + blockNumber + ", " + routeNumber + ");");
	myRoute = routeNumber;
	
	if(map == null) {
		var stop = getDbValue("ActiveNumberedBusStop");
		if(stop != null) {
			var myNumberedStop = JSON.parse(stop);
			console.log("busNumberClicked2 line 367, myNumberedStop=" + myNumberedStop + " calling initializeMap2.");
			initializeMap2(myNumberedStop);
		}
	}

	busNumberClicked(blockNumber);
	return;
}

function busNumberClicked(blockNumber) {
	if(myBlockNumber == blockNumber) {
		console.log("busNumberClicked  myBlockNumber=" + myBlockNumber + " blockNumber=" + blockNumber);
		showBusLocation2(myRoute, blockNumber);
		if(map == null) {
			var stop = getDbValue("Stop." + myStop);
			if(stop != null) {
				var stopMine = JSON.parse(stop);
				initializeMap2(stopMine);
				console.log("busNumberClicked line 280, stopMine=" + stopMine + " initializeMap2 called.");
			}
		}
		showBusLocation2(myRoute, blockNumber);
		return;
	}

	myBlockNumber = blockNumber;
	// set a timeout for when to stop tracking the bus by BlockNumber.
	//                                                         20 minutes from now
	myBlockNumberTimeout = (new Date((new Date()).getTime() + (20 * 60 * 1000)))
	// save the current row's info, so it can be used to populate the missing row.

	if(Modernizr.localstorage) {
		var p =  getDbValue("RouteDirectionStopDeparture." + myRoute + "." + myDirection + "." + myStop);
		if(p != null) {
			var arr = JSON.parse(p);
			var i;
			for(i = 0; i < arr.length; i++) {
				if(arr[i].BlockNumber == blockNumber) {
					console.log("busNumberClicked  i=" + i + " blockNumber=" + blockNumber);

					var newValue = JSON.stringify(arr[i]);	
					var isOk = setDbValue("VehicleTracked." + blockNumber, newValue);
					console.log("busNumberClicked  setDbValue VehicleTracked." + blockNumber + " isOk=" + isOk + "  newValue=" + newValue);
					
					if(map == null) {
						var stop = getDbValue("Stop." + myStop);
						if(stop != null) {
							var stopMine = JSON.parse(stop);
							initializeMap2(stopMine);
							console.log("busNumberClicked, stopMine=" + stopMine + " initializeMap2 called.");
						}
					}
				}
			}
		}
	}
}

function routeClicked(route) {
	if(myRoute == null || myRoute != route) {
		$("#selectDirectionButton").removeClass("active");	
		$("#selectStopButton").removeClass("active");	
	}
	myRoute = route;
	// show the selected route 
	document.getElementById('selectedRoute').innerHTML = '&nbsp;:&nbsp;' + route + '&nbsp;&nbsp;&nbsp;';
	selectRouteDirections(route);
}

// --------------------- RouteDirections
function selectRouteDirectionsUsingMyRoute() {
	$("#selectStopButton").removeClass("active");	
	selectRouteDirections2(myRoute, true);
}

function selectRouteDirections(route) {
	selectRouteDirections2(route, true);
}

function selectRouteDirections2(route, shouldCreateButton) {
	// if route directions are known, use them
	if(Modernizr.localstorage) {
		var p =  getDbValue("RouteDirections." + route);
		if(p != null) {
			if(shouldCreateButton) {
				populateRouteDirections(route, p);
			}
			return;
		}
	}

	var xmlhttp4 = new XMLHttpRequest();
	var url4 = "https://svc.metrotransit.org/NexTrip/Directions/" + route + "?format=json";
	
	// [{"Text":"NORTHBOUND","Value":"4"},{"Text":"SOUTHBOUND","Value":"1"}]
	// 1 = South, 2 = East, 3 = West, 4 = North.
	// one of 2 possible settings   ns or ew, each will cause the UI to show 2 buttons.

	xmlhttp4.onreadystatechange=function(shouldCreateButton) {
		if (xmlhttp4.readyState == 4 && xmlhttp4.status == 200) {
			if(shouldCreateButton) {
				populateRouteDirections(route, xmlhttp4.responseText);
			}
			setDbValue("RouteDirections." + route, xmlhttp4.responseText);
		}
	}
	xmlhttp4.open("GET", url4, true);
	xmlhttp4.send();
}

function populateRouteDirections(route, responseText) {
	var arr = JSON.parse(responseText);
    var i;
	var out = '<div id="routeDirectionButtonGroup" class="btn-group" >';
    for(i = 0; i < arr.length; i++) {
		out += '<button type="button" class="btn btn-primary" onclick="routeDirectionClicked(' + route + ', ' + arr[i].Value + ')" >' + arr[i].Text + '</button>';
	}
    out += "</div>";
    document.getElementById("id00RouteDirectionStop").innerHTML = out;
	document.getElementById("id00RouteDirectionStop").style.display = "block";
	
	$("#selectDirectionButton").addClass("active");	
}

function routeDirectionClicked(route, direction) {
	if(myRoute == null || myRoute != route || myDirection == null || myDirection != direction) {
		$("#selectStopButton").removeClass("active");	
	}
	myRoute = route;
	myDirection = direction;

	// document.getElementById('selectedRoute').innerHTML = '&nbsp;:&nbsp;' + route + '&nbsp;&nbsp;&nbsp;';
	document.getElementById('selectedDirection').innerHTML = '&nbsp;:&nbsp;' + directionAsString(direction) + '&nbsp;&nbsp;&nbsp;';

	// console.log("myRoute=" + myRoute);
	// console.log("myDirection=" + myDirection);
 	selectRouteDirectionStops(route, direction);
}

// --------------------- RouteDirectionStops
function selectRouteDirectionStopsUsingMyDirection(){
	selectRouteDirectionStops2(myRoute, myDirection, true);
}

function selectRouteDirectionStops(route, direction) {
	selectRouteDirectionStops2(route, direction, true);
}

function selectRouteDirectionStops2(route, direction, shouldCreateButtons) {
	// if route direction stops are known, use them
	if(Modernizr.localstorage) {
		var p =  getDbValue("RouteDirectionStops." + route + "." + direction);
		if(p != null) {
			if(shouldCreateButtons) {
				populateRouteDirectionStops(route, direction, p);
			}
			return;
		}
	}

	var xmlhttp5 = new XMLHttpRequest();
	var url5 = "https://svc.metrotransit.org/NexTrip/Stops/" + route + "/" + direction + "?format=json";

	xmlhttp5.onreadystatechange=function(shouldCreateButtons) {
		if (xmlhttp5.readyState == 4 && xmlhttp5.status == 200) {
			if(shouldCreateButtons) {
				populateRouteDirectionStops(route, direction, xmlhttp5.responseText)
			}
			setDbValue("RouteDirectionStops." + route + "." + direction, xmlhttp5.responseText);
		}
	}
	xmlhttp5.open("GET", url5, true);
	xmlhttp5.send();
}

function populateRouteDirectionStops(route, direction, responseText) {
	var arr = JSON.parse(responseText);
    var i;
	// var out = '<div id="routeDirectionStopButtonGroup" class="btn-group btn-group-sm" >';
	var out = '<div id="routeDirectionStopButtonGroup" class="btn-group" >';
    for(i = 0; i < arr.length; i++) {
		// out += '<button type="button" class="btn btn-primary col-md-6 col-sm-4" onclick="routeDirectionStopClicked(' + route + ', ' + direction + ', &quot;' + arr[i].Value + '&quot;)" >' + arr[i].Text + '</button>';
		out += '<button type="button" class="btn btn-primary" onclick="routeDirectionStopClicked(' + route + ', ' + direction + ', &quot;' + arr[i].Value + '&quot;, &quot;' + arr[i].Text + '&quot;)" >' + arr[i].Text + '</button>';
	}
    out += "</div>";
	// console.log("out=" + out);
	var id00Route = document.getElementById("id00RouteDirectionStop");
    id00Route.innerHTML = out;
	id00Route.style.display = "block";
	document.getElementById("separator").style.display = "block";

	$("#selectStopButton").addClass("active");	
}

function routeDirectionStopClicked(route, direction, stop, stopDescription) {
	myRoute = route;
	myDirection = direction;
	
	if((myStop == null) || (myStop != stop)) {
		document.getElementById('selectedStop').innerHTML = '&nbsp;:&nbsp;' + stopDescription + '&nbsp;&nbsp;&nbsp;';
	}
	myStop = stop;
	// console.log("myRoute=" + myRoute);
	// console.log("myDirection=" + myDirection);
	// console.log("myStop=" + myStop);
 	getDepartures(route, direction, stop);
}

// --------------------- Departures
function getDepartures(route, direction, stop) {
	//  Sensitive to whether the stop has times scheduled

	var xmlhttp6 = new XMLHttpRequest();
	var url6 = "https://svc.metrotransit.org/NexTrip/" + route + "/" + direction + "/" + stop + "?format=json";
	// console.log("url6=" + url6);
	
	xmlhttp6.onreadystatechange=function() {
		if (xmlhttp6.readyState == 4 && xmlhttp6.status == 200) {
			populateDepartures(route, direction, stop, xmlhttp6.responseText)
		}
	}
	xmlhttp6.open("GET", url6, true);
	xmlhttp6.send();
}

function populateDepartures(route, direction, stop, responseText) {
	var arr = JSON.parse(responseText);
    var i;
	var isValid = false;
	var hasActuals = false;
	var actualBlockNumber = 0;
	
	var targetPoint = null;
	var scheduledStop = getDbValue("Stop." + stop);
	if(scheduledStop != null) {
		targetPoint = JSON.parse(scheduledStop);
	}
	
	// var out = "<table><tr><th>Actual</th><th>Route</th><th>Departure</th><th>Banner</th><th>Milestone</th><th>Miles</th></tr>";
	var out = '<div class="table-responsive"><table class="table table-bordered"><tr class="table-row table-header"><th>Actual</th><th>Route</th><th>Departure</th><th>Banner</th><th>Milestone</th><th>Miles</th></tr>';
	
	// a tracked bus number, could disappear from these results, even though it has not reached the stop
	//     need to detect that the tracked bus number is not in the results
	var shouldShowTrackedBus = false;
	if(myBlockNumber > 0 && (new Date()) < myBlockNumberTimeout) {
		var hasBlockNumberMatch = false;
		for(i = 0; i < arr.length; i++) {
			if(arr[i].BlockNumber == myBlockNumber) {
				hasBlockNumberMatch = true;
			}
		}
		shouldShowTrackedBus = !hasBlockNumberMatch;
		console.log("populateDepartures  myBlockNumber:" + myBlockNumber + ", shouldShowTrackedBus:" + shouldShowTrackedBus);
		
		if(shouldShowTrackedBus) {
			// need to be able to add based on a saved row, 
			if(Modernizr.localstorage) {
				var p = getDbValue("VehicleTracked." + myBlockNumber);
				if(p != null) {
					var pI = JSON.parse(p);

					var milesAndDirectionLetter = " ? ";
					
					// pI will have a stale version of the row
					//     getDbValue("VehicleLocation.14.1350")    VehicleLocation.14.1350={"direction":1, "locationTime":"/Date(1491594644000-0500)/", "latitude":44.97766, "longitude":-93.27093}
					var vT = getDbValue("VehicleLocation." + route + "." + myBlockNumber);
					if(vT != null) {
						var vTI = JSON.parse(vT);

						if(targetPoint != null && vTI != null && vTI.latitude != null && vTI.latitude != "0") {
							var busAtPoint = {"latitude": vTI.latitude, "longitude": vTI.longitude};
							var milesAway = miles(busAtPoint, targetPoint);	
							milesAndDirectionLetter = milesAndDirection(milesAway);
						}
					}

					out += '<tr class="table-row">' + '<td id="Actual_' + route + '_' + pI.BlockNumber + '" class="bg-success" >' +	pI.Actual +	'</td><td>' +

					pI.Route + pI.Terminal +
					"</td><td>" +
					" - - " + /* pI.DepartureText + */
					"</td><td>" +
					pI.Description +
					"</td><td>" +
					((pI.VehicleLatitude == null || pI.VehicleLatitude == "0" ) ? "&nbsp;" : passedMilestone(pI).simple) +
					"</td><td>" +
					((milesAndDirectionLetter != "") ? milesAndDirectionLetter :(pI.VehicleLatitude == null || pI.VehicleLatitude == "0" ) ? "&nbsp;" : distanceInMiles3Digits(pI)) +
					"</td></tr>";
				}
			}
		}
	}
	
	console.log("populateDepartures  myBlockNumber:" + myBlockNumber + ", shouldShowTrackedBus:" + shouldShowTrackedBus);
	
    for(i = 0; (i < arr.length) && (i < 5); i++) {
		if(!isValid && arr[i] != null && arr[i].VehicleLatitude != null) {
			isValid = true;
		}
		if(!hasActuals && arr[i].Actual != null && arr[i].Actual) {
			hasActuals = true;
			actualBlockNumber = arr[i].BlockNumber;
		}

		// copied from elsewhere
		var milesAndDirectionLetter = "";
		if(targetPoint != null && arr[i] != null && arr[i].VehicleLatitude != null && arr[i].VehicleLatitude != "0") {
			var busAtPoint = {"latitude": arr[i].VehicleLatitude, "longitude": arr[i].VehicleLongitude};
			var milesAway = miles(busAtPoint, targetPoint);	
			milesAndDirectionLetter = milesAndDirection(milesAway);
		}

		out += '<tr class="table-row">' + 
		((arr[i].Actual == null || !arr[i].Actual) ? '<td>' : '<td id="Actual_' + route + '_' + arr[i].BlockNumber + '" class="bg-success" >') + 
		arr[i].Actual +
		'</td><td>' +

		arr[i].Route + arr[i].Terminal +
		"</td><td>" +
		arr[i].DepartureText +
		"</td><td>" +
		arr[i].Description +
		"</td><td>" +
		((arr[i].VehicleLatitude == null || arr[i].VehicleLatitude == "0" ) ? "&nbsp;" : passedMilestone(arr[i]).simple) +
		"</td><td>" +
		((milesAndDirectionLetter != "") ? milesAndDirectionLetter :(arr[i].VehicleLatitude == null || arr[i].VehicleLatitude == "0" ) ? "&nbsp;" : distanceInMiles3Digits(arr[i])) +
		"</td></tr>";
    }
    out += "</table></div>"
	// console.log("out=" + out);
	
	if(isValid) {
		// do not save until it is known to be a valid response
		setDbValue("RouteDirectionStopDeparture." + route + "." + direction + "." + stop, responseText);
		
		if(stop != myStop) {
			console.log("populateDepartures  stop != myStop: (" + stop + ", " + myStop + ")");
			myStop = stop;
		}
		if(direction != myDirection) {
			console.log("populateDepartures  direction != myDirection: (" + direction + ", " + myDirection + ")");
			myDirection = direction;
		}
		if(route != myRoute) {
			console.log("populateDepartures  route != myRoute: (" + route + ", " + myRoute + ")");
			myRoute = route;
		}
		
		// console.log("RouteDirectionStopDeparture." + route + "." + direction + "." + stop + "=" + responseText);
		
		var currentValue = getDbValue("RouteDirectionStopActive");
		var newValue = "{\"route\":" + route + ", \"direction\":" + direction + ", \"stop\":\"" + stop + "\"}";
		if(currentValue != null && currentValue == newValue) {
			// dbValue already set to this, so assume it's ok to remove the 00A section
		}
		else {
			setDbValue("RouteDirectionStopActive", newValue); // "{\"route\":" + route + ", \"direction\":" + direction + ", \"stop\":\"" + stop + "\"}");
			// setDbValue("ActiveScheduledBusStop", ...);
			var rawStop = getDbValue("Stop" + stop);
			if(rawStop != null) {
				var stopParsed = JSON.parse(rawStop);
				if(stopParsed != null) {
					var busStopPoint = {"stop":stop, "latitude": stopParsed.latitude, "longitude": stopParsed.longitude};
					setDbValue("ActiveScheduledBusStop", JSON.stringify(busStopPoint));
				}
			}
			rotateRecentRoutes();
		}
		document.getElementById("separator").style.display = "none";
		document.getElementById("id00RouteDirectionStop").style.display = "none";
	}

    document.getElementById("title1").innerHTML = "Bus Schedule " + route;
    document.getElementById("id00B").innerHTML = out;
	
	var outButton = "<button type=\"button\" class=\"btn btn-primary\" onclick=\"getDepartures(" + route + ", " + direction + ", &quot;" + stop + "&quot;);\" >" + route + " - " + directionAsString(direction) + " - " + stop + "</button>";
	
	var timeOfQuery = new Date();
	outButton += '<label>&nbsp;&nbsp;' + getStopDescription(route, direction, stop) + '</label><label>&nbsp;&nbsp;' + timeOfQuery.toHHMMSS() + '</label>';
	
    document.getElementById("id00C").innerHTML = outButton;
	
	if(hasActuals) {
		showBusLocation2(route, actualBlockNumber);
	}
}

function getStopDescription(route, direction, stop) {
	if(Modernizr.localstorage) {
		var p =  getDbValue("RouteDirectionStops." + route + "." + direction);
		if(p != null) {
			var stops = JSON.parse(p);
			for(var i = 0; i < stops.length; i++) {
				if(stops[i].Value == stop) {
					return stops[i].Text;
				}
			}
		}
	}
	return "";
}

function rotateRecentRoutes() {
	// assumes that the new value RouteDirectionStopActive has been set
	//   .0 is a copy of RouteDirectionStopActive
	var recentValue = getDbValue("RouteDirectionStopActive.0");
	if(recentValue == null) {
		recentValue = getDbValue("RouteDirectionStopActive");
		if(recentValue != null) {
			setDbValue("RouteDirectionStopActive.0", recentValue);
		}
		return;
	}
	
	var currentValue = getDbValue("RouteDirectionStopActive");
	if(currentValue == null) {
		return;   // something horrible happened!
	}

	// is it already in the list? if so, only need to replace up to that one
	var isAlreadyInTheList = false;
	for(var i=0; i < 5; i++) {
		recentValue = getDbValue("RouteDirectionStopActive." + i);
		if(recentValue == null) { 
			i = 999;
		} else {
			if(recentValue == currentValue) {
				isAlreadyInTheList = true;
				return;
			}
		}
	}
	// console.log("isAlreadyInTheList=" + isAlreadyInTheList);
	
	if(recentValue == currentValue) { return; }
	
	for(var i=4; i >= 0; i--) {
		recentValue = getDbValue("RouteDirectionStopActive." + i);
		if(recentValue != null) {
			setDbValue("RouteDirectionStopActive." + (i + 1), recentValue);
		}
	}
	recentValue = getDbValue("RouteDirectionStopActive");
	if(recentValue != null) {
		setDbValue("RouteDirectionStopActive.0", recentValue);
	}
	resetRecentButtons();
}

function resetRecentButtons() {
	// spin through the 
	for(var i=0; i < 5; i++) {
		var recentIElement = document.getElementById("recent" + i);
		var recentValue = getDbValue("RouteDirectionStopActive." + i);
		if(recentValue == null) {
			recentIElement.hidden = true;
			recentIElement.classList.add("hidden");
		} else {
			recentIElement.hidden = false;
			recentIElement.classList.remove("hidden");
			var recentStop = JSON.parse(recentValue);
			
			//	<li id="recent0" onclick="selectRecent(0);">&nbsp;</li>
			var outListItem = recentStop.route + " - " + directionAsString(recentStop.direction) + " - " + recentStop.stop;
			recentIElement.innerHTML = outListItem;			
		}
	}
}

// example: var s = directionAsString(recentStop.direction);
function directionAsString(direction) {
	// 1 South, 2 East, 3 West, 4 North
	// console.log("directionAsString()  direction=" + direction);
	return ((direction == 1) ? "S" : (direction == 2) ? "E" : (direction == 3) ? "W" : (direction == 4) ? "N" : "?");
}

function selectRecent(item) {
	itemValue = getDbValue("RouteDirectionStopActive." + item);
	if(itemValue != null) {
		var itemStop = JSON.parse(itemValue);
		getDepartures(itemStop.route, itemStop.direction, itemStop.stop);
	}
}

// Where a = line point 1; b = line point 2; c = point to check against.
//public bool isLeft(Point a, Point b, Point c){
//     return ((b.x - a.x)*(c.y - a.y) - (b.y - a.y)*(c.x - a.x)) > 0;
//}

// claim is that this is slightly better
//     return (b.x - a.x)*(c.y - a.y) > (b.y - a.y)*(c.x - a.x);

function isLeftOfLine(pointAOnLine, pointBOnLine, pointC) {
	return (pointBOnLine.longitude - pointAOnLine.longitude)*(pointC.latitude - pointAOnLine.latitude) > (pointBOnLine.latitude - pointAOnLine.latitude)*(pointC.longitude - pointAOnLine.longitude);
}

function distance(latitude1, longitude1, latitude2, longitude2) {
	return Math.sqrt(Math.pow(latitude1 - latitude2, 2) + Math.pow(longitude1 - longitude2, 2));
}

function latitudeDelta(point, wayPoint) {
	return (point.latitude - wayPoint.latitude) * 69.0539;    // includes near 45deg factor
}
function longitudeDelta(point, wayPoint) {
	return (point.longitude - wayPoint.longitude) * 48.9930;    // includes near 45deg factor for longitude
}

function distanceNearLatitude45(point, wayPoint) {
	var latitudeDiff = latitudeDelta(point, wayPoint);
	var longitudeDiff = longitudeDelta(point, wayPoint);
	return Math.sqrt(Math.pow(latitudeDiff, 2) + Math.pow(longitudeDiff, 2));
}

function distanceInMiles3Digits(arrRow) {
	var strMiles = "" + distanceInMiles(arrRow);
	return strMiles.substr(0, 4);
}

function busStopWayPoint(arrRow) {
	if(arrRow.Route=="133") {
		return Marquette400S;  //400 S Marquette
	}
	if(arrRow.Route=="7") {
		return FourthStreet215S;   //215 S 4th St - #7    FourthStreet215S
	}
	if(arrRow.Route=="14") {
		return SixthStreet201S;  //Capella Tower
	}
	return null;
}

function distanceInMiles(arrRow) {
	var busAtPoint = {latitude:arrRow.VehicleLatitude, longitude:arrRow.VehicleLongitude};

	var activeStop;
	if(isCurrentTargetANumberedBusStop) {
		activeStop = getDbValue("ActiveNumberedBusStop");
	}
	else {
		activeStop = getDbValue("ActiveScheduledBusStop");
	}

	var targetPoint;
	if(activeStop != null) {
		targetPoint = JSON.parse(activeStop);
	}
	
	if(targetPoint != null) {
		return distanceNearLatitude45(busAtPoint, targetPoint); 
	}
	
	if(arrRow.Route=="133") {
		return distanceNearLatitude45(busAtPoint, Marquette400S);  //400 S Marquette
	}
	if(arrRow.Route=="7") {
		return distanceNearLatitude45(busAtPoint, FourthStreet215S);   //215 S 4th St - #7    FourthStreet215S
	}
	if(arrRow.Route=="14") {
		return distanceNearLatitude45(busAtPoint, SixthStreet201S);  //Capella Tower
	}
	return "";
}

function miles(aPoint, aWayPoint) {
	var obj = {};
	obj.point = aPoint;
	obj.wayPoint = aWayPoint;
	obj.between = distanceNearLatitude45(aPoint, aWayPoint);
	obj.north = latitudeDelta(aPoint, aWayPoint);
	obj.east  = longitudeDelta(aPoint, aWayPoint);
	obj.isNorthOf = obj.north > 0.01;
	obj.isSouthOf = obj.north < 0.01;
	obj.isEastOf = obj.east > 0.01;        // longitude increases as you go east
	obj.isWestOf = obj.east < 0.01;

	// angle in degrees
	obj.angleInDegrees = Math.atan2(aPoint.longitude - aWayPoint.longitude, aPoint.latitude - aWayPoint.latitude) * 180 / Math.PI;

	return obj;
}

function milesAsString(miles) {
	if(miles == null) return;
	
	return "(" + miles.point.latitude.toFixed(6) + ", " + miles.point.longitude.toFixed(6) + ") vs ("  + miles.wayPoint.latitude.toFixed(6) + ", " + miles.wayPoint.longitude.toFixed(6) + ")"
		+ " .between=" + miles.between.toFixed(2) + " miles, .north=" + miles.north.toFixed(2) + ", .east=" + miles.east.toFixed(2) 
		+ ", " + (miles.isNorthOf ? "N" : (miles.isSouthOf) ? "S" : "")  
		+ ", " + (miles.isEastOf ? "E" : (miles.isWestOf) ? "W" : "") 
		;
}

function milesAndDirection(miles) {
	if(miles == null) return;

	if( 180.0 - 11.25 < miles.angleInDegrees && miles.angleInDegrees <  180.0 + 11.25) { return miles.between.toFixed(2) + " S"; }
	if(-180.0 - 11.25 < miles.angleInDegrees && miles.angleInDegrees < -180.0 + 11.25) { return miles.between.toFixed(2) + " S"; }
	if(-157.5 - 11.25 < miles.angleInDegrees && miles.angleInDegrees < -157.5 + 11.25) { return miles.between.toFixed(2) + " SSW"; }
	if(-135.0 - 11.25 < miles.angleInDegrees && miles.angleInDegrees < -135.0 + 11.25) { return miles.between.toFixed(2) + " SW"; }
	if(-112.5 - 11.25 < miles.angleInDegrees && miles.angleInDegrees < -112.5 + 11.25) { return miles.between.toFixed(2) + " WSW"; }
	if( -90.0 - 11.25 < miles.angleInDegrees && miles.angleInDegrees <  -90.0 + 11.25) { return miles.between.toFixed(2) + " W"; }
	if( -67.5 - 11.25 < miles.angleInDegrees && miles.angleInDegrees <  -67.5 + 11.25) { return miles.between.toFixed(2) + " WNW"; }
	if( -45.0 - 11.25 < miles.angleInDegrees && miles.angleInDegrees <  -45.0 + 11.25) { return miles.between.toFixed(2) + " NW"; }
	if( -22.5 - 11.25 < miles.angleInDegrees && miles.angleInDegrees <  -22.5 + 11.25) { return miles.between.toFixed(2) + " NNW"; }
	if(   0.0 - 11.25 < miles.angleInDegrees && miles.angleInDegrees <    0.0 + 11.25) { return miles.between.toFixed(2) + " N"; }
	if(  22.5 - 11.25 < miles.angleInDegrees && miles.angleInDegrees <   22.5 + 11.25) { return miles.between.toFixed(2) + " NNE"; }
	if(  45.0 - 11.25 < miles.angleInDegrees && miles.angleInDegrees <   45.0 + 11.25) { return miles.between.toFixed(2) + " NE"; }
	if(  67.5 - 11.25 < miles.angleInDegrees && miles.angleInDegrees <   67.5 + 11.25) { return miles.between.toFixed(2) + " ENE"; }
	if(  90.0 - 11.25 < miles.angleInDegrees && miles.angleInDegrees <   90.0 + 11.25) { return miles.between.toFixed(2) + " E"; }
	if( 112.5 - 11.25 < miles.angleInDegrees && miles.angleInDegrees <  112.5 + 11.25) { return miles.between.toFixed(2) + " ESE"; }
	if( 135.0 - 11.25 < miles.angleInDegrees && miles.angleInDegrees <  135.0 + 11.25) { return miles.between.toFixed(2) + " SE"; }
	if( 157.5 - 11.25 < miles.angleInDegrees && miles.angleInDegrees <  157.5 + 11.25) { return miles.between.toFixed(2) + " SSE"; }
	
	if(miles.isNorthOf && (Math.abs(miles.north) > Math.abs(miles.east) * 2.0)) {
		// more north than northwest or northeast
		return miles.between.toFixed(2) + " Nx";
	}
		
	if(miles.isSouthOf && (Math.abs(miles.north) > Math.abs(miles.east) * 2.0)) {
		return miles.between.toFixed(2) + " Sx";
	}

	if(miles.isEastOf && (Math.abs(miles.east) > Math.abs(miles.north) * 2.0)) {
		return miles.between.toFixed(2) + " Ex";
	}

	if(miles.isWestOf && (Math.abs(miles.east) > Math.abs(miles.north) * 2.0)) {
		return miles.between.toFixed(2) + " Wx";
	}

	if(miles.isNorthOf && miles.isWestOf) {
		return miles.between.toFixed(2) + " NWx";
	}

	if(miles.isNorthOf && miles.isEastOf) {
		return miles.between.toFixed(2) + " NEx";
	}

	if(miles.isSouthOf && miles.isEastOf) {
		return miles.between.toFixed(2) + " SEx";
	}

	if(miles.isSouthOf && miles.isWestOf) {
		return miles.between.toFixed(2) + " SWx";
	}

	if(miles == null || miles.between == null) {
		return "n/a";
	}

	return miles.between.toFixed(2) + " ??";
}

function isNorthAndEastOf(miles, between) {
	return miles.isNorthOf && miles.isEastOf && miles.between <= between;
}

// change to return an object that has {detail: string, simple: string}
function passedMilestone(arrRow) {
	var busAtPoint = {latitude:arrRow.VehicleLatitude, longitude:arrRow.VehicleLongitude};
	
	if(arrRow.Route=="133") {
		// false	133	4:15	Ltd Stop/Bloomington/Chicago Av	SOUTHBOUND	1420	A	44.975585, -93.264102	0.32	35W & Franklin	(44.975585, -93.264102) vs (44.979001, -93.268623) .between=0.32 miles, .north=-0.24, .east=0.22, isSouthOf, isEastOf
		// true	133	14 Min	Ltd Stop/Bloomington/Chicago Av	SOUTHBOUND	1824	A	44.97874, -93.26189	0.33	Start of run (Gateway Ramp)	(44.978740, -93.261890) vs (44.979001, -93.268623) .between=0.33 miles, .north=-0.02, .east=0.33, isSouthOf, isEastOf
		
		var milesSWofWashington300S = miles(busAtPoint, SWofWashington300S);
		if(isNorthAndEastOf(milesSWofWashington300S, 0.2)) {
			return {detail: "NE of 3rd and Washington" + " :" + milesAsString(milesSWofWashington300S),
			        simple: milesAndDirection(milesSWofWashington300S) + " of 3rd &amp; Wash"};
		}

		var milesSouthAndWestOfGatewayRamp = miles(busAtPoint, SouthAndWestOfGatewayRamp);
		if(milesSouthAndWestOfGatewayRamp.isNorthOf && milesSouthAndWestOfGatewayRamp.isEastOf && milesSouthAndWestOfGatewayRamp.between < 0.15) {
//			alert("milesSouthAndWestOfGatewayRamp=" + milesAsString(milesSouthAndWestOfGatewayRamp) + "   Start of run (Gateway Ramp)");
			return {detail: "Start of run (Gateway Ramp)" + milesAsString(milesSouthAndWestOfGatewayRamp),
			        simple: milesAndDirection(milesSouthAndWestOfGatewayRamp) + " start of run"};
		}
		
		var milesWashington300S = miles(busAtPoint, Washington300S);
		if(milesWashington300S.isNorthOf && milesWashington300S.isEastOf && milesWashington300S.between < 0.2) {
//			alert("milesWashington300S=" + milesAsString(milesWashington300S) + "   East of 3rd and Washington");
			return {detail: "East of 3rd and Washington" + milesAsString(milesWashington300S),
					simple: milesAndDirection(milesWashington300S) + " of 3rd &amp; Wash"};
		}
		if(milesWashington300S.isNorthOf && milesWashington300S.isWestOf && milesWashington300S.between < 0.2) {
//			alert("milesWashington300S=" + milesAsString(milesWashington300S) + "   Crossed 3rd and Washington");
			return {detail: "Crossed 3rd and Washington" + milesAsString(milesWashington300S),
					simple: milesAndDirection(milesWashington300S) + " crossed 3rd &amp; Wash"};
		}
		
		var milesGrantAnd35W = miles(busAtPoint, GrantAnd35W);
		if(milesGrantAnd35W.isSouthOf) {
			return {detail: "Still south of downtown" + milesAsString(milesGrantAnd35W),
					simple: milesAndDirection(milesGrantAnd35W) + " of downtown"};
		}
		if(milesGrantAnd35W.east < -1.0) {
			return {detail: "West of downtown" + milesAsString(milesGrantAnd35W),
					simple: milesAndDirection(milesGrantAnd35W) + " of downtown"};
		}
		
		var miles400SMarquette = miles(busAtPoint, Marquette400S);

		var distanceFrom400SMarquette = distance(arrRow.VehicleLatitude, arrRow.VehicleLongitude, Marquette400S.latitude, Marquette400S.longitude);
		var distanceFrom5thAndWashington = distance(arrRow.VehicleLatitude, arrRow.VehicleLongitude, Washington500N.latitude, Washington500N.longitude);
		if(distanceFrom400SMarquette <= 0.0001) {
			return {detail: "here", 
					simple: milesAndDirection(miles400SMarquette) + " from Stop"};
			}
		if(distanceFrom400SMarquette <= 0.0169) {
			return {detail: "35W &amp; Franklin",
					simple: milesAndDirection(miles400SMarquette) + " near 35W &amp Franklin"};
		}
		if(distanceFrom400SMarquette <= 1 && distanceFrom5thAndWashington <= 0.2) {
			return {detail: "Turning to head south", 
					simple: milesAndDirection(miles400SMarquette) + " turning to head south"};
		}
		else {
			return {detail: "outside downtown, " + milesAsString(miles400SMarquette),
					simple: milesAndDirection(miles400SMarquette) + "outside downtown"};
		}
	}
	if(arrRow.Route=="14") {
		var milesAway = miles(busAtPoint, SixthStreet201S);
		
		var milesBroadwayEmerson = miles(busAtPoint, BroadwayEmerson);
		if(milesBroadwayEmerson.isWestOf) {
			return {detail: "West of Broadway Emerson" + " :" + milesAsString(milesBroadwayEmerson),
					simple: milesAndDirection(milesBroadwayEmerson) + " of Broadway &amp; Emerson"};
		}

		var milesPlymouthWashington = miles(busAtPoint, PlymouthWashington);
		if(milesPlymouthWashington.east < 0.1 && milesPlymouthWashington.north > -0.1 ) {
			return {detail: "West of Plymouth and Washington" + " :" + milesAsString(milesPlymouthWashington), 
					simple: milesAndDirection(milesPlymouthWashington) + " of Plymouth &amp; Wash"};
		}

		var milesWashington300N = miles(busAtPoint, Washington300N);
		if(milesWashington300N.isWestOf && milesWashington300N.isNorthOf && milesWashington300N.between < 1) {
			return {detail: "NW of 3rd Ave N and Washington" + " :" + milesAsString(milesWashington300N),
					simple: milesAndDirection(milesWashington300N) + " of 3rd Ave N &amp; Wash"};
		}
		
		var milesFifthStBusRamp = miles(busAtPoint, FifthStBusRamp);
		if(milesFifthStBusRamp.isNorthOf && milesFifthStBusRamp.north < 0.2) {
			return {detail: "At 5th Street Bus Ramp" + " :" + milesAsString(milesFifthStBusRamp), 
					simple: milesAndDirection(milesFifthStBusRamp) + " of 5th St Bus Ramp"};
		}
		
		var milesFromSixthNicollet = miles(busAtPoint, SixthNicollet);
		if(milesFifthStBusRamp.isSouthOf && milesFifthStBusRamp.isEastOf && milesFromSixthNicollet.isNorthOf && milesFromSixthNicollet.isWestOf && milesFromSixthNicollet.between > 0.05) {
			return {detail: "Nearing Nicollet Mall" + " :" + milesAsString(milesFromSixthNicollet),
					simple: milesAndDirection(milesFromSixthNicollet) + " of 6th &amp; Nicollet"};
		}			

		if(milesFromSixthNicollet.isNorthOf && milesFromSixthNicollet.between < 0.05) {
			return {detail: "At Nicollet Mall" + " :" + milesAsString(milesFromSixthNicollet),
					simple: milesAndDirection(milesFromSixthNicollet) + " Nicollet Mall"};
		}			
				
		if(Math.abs(milesAway.between) < 0.0001) {
			return {detail: "here",
					simple: milesAndDirection(milesAway) + " of Capella"};
 		}
		if(milesAway.isNorthOf && milesAway.isWestOf && Math.abs(milesAway.between) <= 0.0041) {
			return {detail: "Nicollet Mall",
					simple: milesAndDirection(milesAway) + " of Capella"};
 		}
		
		return {detail: "todo - " + milesAsString(milesAway),
				simple: milesAndDirection(milesAway) + " of Capella"};
	}
	if(arrRow.Route=="7") {
		var milesFrom215s4thSt = miles(busAtPoint, FourthStreet215S);

		if(Math.abs(milesFrom215s4thSt.between) < 0.0001) {
			return {detail: "here",
					simple: milesAndDirection(milesFrom215s4thSt) + " at the Stop"};
 		}

		return {detail: "todo - " + milesAsString(milesFrom215s4thSt),
				simple: milesAndDirection(milesFrom215s4thSt) + " of 215 S 4th"};

	}
	return {detail: "Route not implemented.",
			simple: "n/a"};
}
	
function timeSince(when) { // this ignores months
	var obj = {};
	obj._milliseconds = (new Date()).valueOf() - when.valueOf();
	obj.milliseconds = obj._milliseconds % 1000;
	obj._seconds = (obj._milliseconds - obj.milliseconds) / 1000;
	obj.seconds = obj._seconds % 60;
	obj._minutes = (obj._seconds - obj.seconds) / 60;
	obj.minutes = obj._minutes % 60;
	obj._hours = (obj._minutes - obj.minutes) / 60;
	obj.hours = obj._hours % 24;
	obj._days = (obj._hours - obj.hours) / 24;
	obj.days = obj._days % 365;
	obj.years = (obj._days - obj.days) / 365;
	return obj;
}

// -------------------------------- local storage -- start
// see http://diveintohtml5.info/storage.html

function supports_html5_storage() {
  try {
    return 'localStorage' in window && window['localStorage'] !== null;
  } catch (e) {
    return false;
  }
}

function setDbValue(name, setting) {
    if (!supports_html5_storage()) { return false; }
    localStorage["BusSchedule." + name] = setting;
	return true;
}
function getDbValue(name) {
    if (!supports_html5_storage()) { return null; }
    return localStorage["BusSchedule." + name];
}
function deleteDbKeysStartingWith(prefix) {
    if (!supports_html5_storage()) { return null; }
	var i = 0;
	var result = null;
	do {
		result = localStorage.key(i);
		if(result != null && result.indexOf("BusSchedule." + prefix) == 0) {
			localStorage.removeItem(result);
		} else {
			i++;
		}
	} 
	while (result != null);
    return true;
}

function getDbSize() {
	if (localStorage && !localStorage.getItem('size')) {
		var i = 0;
		try {
			// Test up to 10 MB
			for (i = 250; i <= 10000; i += 250) {
				localStorage.setItem('test', new Array((i * 1024) + 1).join('a'));
			}
		} catch (e) {
			localStorage.removeItem('test');
			localStorage.setItem('size', i - 250);            
		}
	}
	if (localStorage) {
		return localStorage.getItem('size');
	}
}

function resetDatabase() {
    if (!supports_html5_storage()) { return null; }
	localStorage.clear();
}

function showDatabase() {
	// show SQL that could be used in a query for Stop names of a route
    // BusSchedule.RouteDirectionStops.133.1	[{"Text":"Gateway Ramp ","Value":"GTWY"},{"Text":"Marquette Ave and 4th St ","Value":"MA4S"},{"Text":"Marquette Ave and 8th St ","Value":"MA8S"},{"Text":"12th St and 3rd Ave ","Value":"123A"},{"Text":"I-35W and Lake St","Value":"I3LA"},{"Text":"38th St and Chicago Ave","Value":"38CH"},{"Text":"Chicago Ave and 46th St","Value":"46CH"},{"Text":"54th St and Bloomington Ave","Value":"BL54"},{"Text":"1000 46th St E ","Value":"1046"}]	
    // BusSchedule.RouteDirectionStops.133.4	[{"Text":"1000 46th St E ","Value":"1046"},{"Text":"Bloomington Ave and 54th St","Value":"BL54"},{"Text":"Chicago Ave and 46th St","Value":"46CH"},{"Text":"38th St and Chicago Ave","Value":"38CH"},{"Text":"2nd Ave and 11th St ","Value":"112A"},{"Text":"2nd Ave and 7th St ","Value":"7S2A"},{"Text":"2nd Ave and Washington Ave ","Value":"WA2A"}]	
    if (!supports_html5_storage()) { return null; }

	var routeDirectionCount = 0;
	for(var i=0, len = localStorage.length; i < len; ++i){
		if(localStorage.key(i).substring(0, "BusSchedule.RouteDirectionStops.".length) == "BusSchedule.RouteDirectionStops.") {
			if(++routeDirectionCount < 9999) { // 14, 30, 45, 64, 77, 93, 111
				console.log("routeDirectionCount=" + routeDirectionCount);
				var rawValues = localStorage.getItem(localStorage.key(i));
				var values = JSON.parse(rawValues);
				for(var j=0, valuesLength = values.length; j < valuesLength; ++j) {
					var value = values[j];
					console.log("('" + localStorage.key(i).substring("BusSchedule.RouteDirectionStops.".length) + "', '" + value.Text + "', '" + value.Value + "', " + j + "), "); 
				}
			}
		}
	}
}

// console.log("localStorage size=" + getDbSize());	
// -------------------------------- local storage -- end

function visitAllRoutes() {
	// to populate the local database with values that showDatabase() can use.
    if (!supports_html5_storage()) { 
		return; 
	}
	
	var rawRoutes = getDbValue("Routes");
	if(rawRoutes == null) { return; }
	
	var arrRoutes = JSON.parse(rawRoutes);
	for(i = 0; i < arrRoutes.length; i++) {
		// need to determine the valid directions for each route
		var route = arrRoutes[i].Route;
		// is there a function to call that does not create/update a button?
		var shouldCreateButton = false;
		selectRouteDirections2(route, shouldCreateButton);
	}
	
	// now, go through the RouteDirections
	for(var i=0, len = localStorage.length; i < len; ++i){
		if(localStorage.key(i).substring(0, "BusSchedule.RouteDirections.".length) == "BusSchedule.RouteDirections.") {
			var rawValues = localStorage.getItem(localStorage.key(i));
			var values = JSON.parse(rawValues);
			for(var j=0, valuesLength = values.length; j < valuesLength; ++j) {
				var direction = values[j].Value;
				var route = localStorage.key(i).substring("BusSchedule.RouteDirections.".length);
				selectRouteDirectionStops2(route, direction, false);
			}
		}
	}
}

// --------------------------------------------
// from https://developer.mozilla.org/en-US/docs/Web/API/Geolocation/getCurrentPosition
// and
// from https://developer.mozilla.org/en-US/docs/Web/API/Geolocation/Using_geolocation

var currentDeviceGps;   // .coords of success callback of .getCurrentPosition

function getGps() {
    var output = document.getElementById("mapPanelHeadingLabel");

    if (!navigator.geolocation){
        output.innerHTML = '<p class="text-danger">Geolocation is not supported by your browser</p>';
        return;
    }

    function success(position) {
        // var latitude  = position.coords.latitude;
        // var longitude = position.coords.longitude;

	    currentDeviceGps = position.coords;
		
	    console.log('Your current position is:');
	    console.log(`Latitude : ${currentDeviceGps.latitude}`);
	    console.log(`Longitude: ${currentDeviceGps.longitude}`);
	    console.log(`More or less ${currentDeviceGps.accuracy} meters.`);

        initializeMap();
    }

    function error() {
	    output.innerHTML = '<span class="text-danger">Unable to retrieve your location</span>';
    }

	var options = {
	  enableHighAccuracy: true,
	  timeout: 5000,        // wait up to 5000 milliseconds
	  maximumAge: 30000     // milliseconds old or less, retrieve from cache.  0 to always get the latest position, never from cache
	};
  
    output.innerHTML = '<span class="text-default">Locating . . . </span>';

    navigator.geolocation.getCurrentPosition(success, error, options);
}
// --------------------------------------------

// ----- create map and add markers ------ start
// based on http://stackoverflow.com/questions/5319488/how-to-set-google-map-marker-by-latitude-and-longitude-and-provide-infomation-bu
// fills the <div id="map_canvas"></div>
var map;
var markers = [];

function initializeMap() { return initializeMap2(currentDeviceGps); }

function initializeMap2(position) {
	if(position == null || position.latitude == null) {return;}

	if(document.getElementById("map_canvas").hidden) {return;}
	
    var latlng = new google.maps.LatLng(position.latitude, position.longitude);
    var myOptions = {
        zoom: 14,   // stackoverflow version was set to 1
        center: latlng,
        mapTypeId: google.maps.MapTypeId.ROADMAP
    }
    map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
	addMarker(position);
	
	addBlockButtonToMapTitle();
	addResetButtonToMapTitle();
}

function addBlockButtonToMapTitle() {
	console.log("addBlockButtonToMapTitle markupBlockNumberButton(myBlockNumber)  myBlockNumber=" + myBlockNumber);
	var divInTitle = document.getElementsByClassName("map-title");
	var markup = markupBlockNumberButton(myBlockNumber);
	markup = markup.replace(' onclick', ' style="margin-left: 30%; margin-right: 20%" onclick');
	divInTitle[0].innerHTML = markup;
}

function addResetButtonToMapTitle() {
	console.log("addResetButtonToMapTitle() called.");
	var mapTitleResetButton = document.getElementById("mapTitleResetButton");
	if(mapTitleResetButton === null) {
		var divInTitle = document.getElementsByClassName("map-title");
		if(divInTitle != null) {
			divInTitle[0].innerHTML = divInTitle[0].innerHTML + 
				'<button type="button" class="btn btn-primary btn-sm" style="margin-right: 10%;" onclick="clearTracking()">Reset Map</button>';
		}
	}
}

// addMarker(" + stopNumber + ", " + blockNumber + ", " + row + ");
function addMarkerForStop(stopNumber, blockNumber, rowId) {
	console.log("addMarkerForStop  stopNumber=" + stopNumber + " blockNumber=" + blockNumber + " rowId=" + rowId + "  departuresByStopNumber(" + rowId + ")=" + JSON.stringify(departuresByStopNumber[rowId]));
	
	var row = departuresByStopNumber[rowId];
	var current = new google.maps.LatLng(row.VehicleLatitude, row.VehicleLongitude);
	
	var activeNumberedBusStopNumber = getDbValue("ActiveNumberedBusStop");
	if(activeNumberedBusStopNumber != null) {
		// has the numberedBusStop already been added to the markers?
		var activeStop = JSON.parse(activeNumberedBusStopNumber);
		if(activeStop != null) {
			var isAlreadyAdded = false;
			// where did markers come from? global variable
			for (var i = 0; i < markers.length; i++) {
				if (activeStop.latitude === markers[i].position.lat() && activeStop.longitude === markers[i].position.lng()) {
					isAlreadyAdded = true;
				}
			}
			if(!isAlreadyAdded) {
				var latLngBusStop = new google.maps.LatLng(activeStop.latitude, activeStop.longitude);
				var	marker = new google.maps.Marker({
					map: map,
					position: latLngBusStop,
					icon: {
						path: google.maps.SymbolPath.CIRCLE,
						scale: 5
						}
				});
				markers.push(marker);

				markers[markers.length - 1]['infowin'] = new google.maps.InfoWindow({
					content: '<div>stop #:' + activeStop.StopNumber + '</div>'
				});
				
				google.maps.event.addListener(markers[markers.length - 1], 'click', function() {
					this['infowin'].open(map, this);
				});
			}
		}
	}
	
	// if map is null, create one
	if(map == null) {
		console.log("map is null.  addMarkerForStop(stopNumber, blockNumber, rowId)");
		var activeNumberedStop = JSON.parse(activeNumberedBusStopNumber);
		if(activeNumberedStop != null) {
			console.log("create map, activeNumberedStop = " + JSON.stringify(activeNumberedStop));
			initializeMap2(activeNumberedStop);
		} else {
			console.log("create map, current = " + JSON.stringify(current));
			initializeMap2(current);
		}
		return;
	}	
}

function addMarker(busLocation) {
	console.log("addMarker  busLocation=" + JSON.stringify(busLocation));
	
    for (var i = 0; i < markers.length; i++)
		if (busLocation.latitude === markers[i].position.lat() && busLocation.longitude === markers[i].position.lng()) return;

	var current = new google.maps.LatLng(busLocation.latitude, busLocation.longitude);
	
	if(map == null) {
		console.log("map is null.  addMarker(busLocation)");
		return;
	}
	
	var marker;
	if(busLocation.time == null) {
		marker = new google.maps.Marker({
			map: map,
			position: current,
			icon: {
				path: google.maps.SymbolPath.CIRCLE,
				scale: 5
				}
		});
	} else
	{
		marker = new google.maps.Marker({
			map: map,
			position: current,
			title: "" + busLocation.blockNumber
		});
	} 
    markers.push(marker);

	// busLocation.time does not exist when the location is actually a bus stop, not a bus location
	if(busLocation.time != null) {
		markers[markers.length - 1]['infowin'] = new google.maps.InfoWindow({
			content: '<div>' + busLocation.time.toHHMMSS().substr(3,2) + 'm' + busLocation.time.toHHMMSS().substr(6,2) + 's</div>'
				+ '<div>' + busLocation.blockNumber + '</div>'
		});
		
		google.maps.event.addListener(markers[markers.length - 1], 'click', function() {
			this['infowin'].open(map, this);
		});
	}
}
// ----- create map and add markers ------ end

function clearTracking() {
	deleteDbKeysStartingWith("VehicleTracked.");
	deleteDbKeysStartingWith("VehicleLocation.");
	document.getElementById("map_canvas").innerHTML = "";
	map = null;
	markers = [];
}


</script>
</head>

<body>
<nav role="navigation" class="navbar navbar-default navbar-static-top">
	<div class="container">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" data-target="#navbarCollapse" data-toggle="collapse" class="navbar-toggle">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<span class="navbar-brand" id="title1" >Bus Schedule</span>
		</div>
		<!-- Collection of nav links and other content for toggling -->
		<div id="navbarCollapse" class="collapse navbar-collapse">
			<ul class="nav navbar-nav">
				<li id="recent0" class="active btn btn-default hidden" onclick="selectRecent(0);">&nbsp;</li>
				<li id="recent1" class="active btn btn-default hidden" onclick="selectRecent(1);">&nbsp;</li>
				<li id="recent2" class="active btn btn-default hidden" onclick="selectRecent(2);">&nbsp;</li>
				<li id="recent3" class="active btn btn-default hidden" onclick="selectRecent(3);">&nbsp;</li>
				<li id="recent4" class="active btn btn-default hidden" onclick="selectRecent(4);">&nbsp;</li>
				<li class="divider btn hidden" />
				<li id="recentStop0" class="active btn btn-default hidden" onclick="selectRecentStop(0);">&nbsp;</li>
				<li id="recentStop1" class="active btn btn-default hidden" onclick="selectRecentStop(1);">&nbsp;</li>
				<li id="recentStop2" class="active btn btn-default hidden" onclick="selectRecentStop(2);">&nbsp;</li>
				<li id="recentStop3" class="active btn btn-default hidden" onclick="selectRecentStop(3);">&nbsp;</li>
				<li id="recentStop4" class="active btn btn-default hidden" onclick="selectRecentStop(4);">&nbsp;</li>
			</ul>
			<ul class="nav navbar-nav navbar-right">
				<div class="dropdown">
					<li class="btn btn-default dropdown-toggle" data-toggle="dropdown" >
						Utils<span class="caret"></span>
					</li>
						<ul class="dropdown-menu" >
							<li class="btn btn-primary" id="utilClearTracking" onclick="clearTracking()">Clear tracking</li>
							<li class="divider"></li>
							<li class="btn btn-warning" id="utilGetGps"       onclick="getGps()">Show my location</li>
							<li class="btn btn-warning" id="utilWriteStops"   onclick="showDatabase()">Write stops to console</li>
							<li class="btn btn-warning" id="utilVisitRoutes"  onclick="visitAllRoutes()">Visit all routes</li>
							<li class="divider"></li>
							<li class="btn btn-danger" id="utilResetDataase" onclick="resetDatabase()">Delete all local data</li>
						</ul>
				</div>
			</ul>
		</div>
	</div>
</nav>

<div id="separator" class="hr" style="display: none;" > 
	<hr>
</div>

<div id="id00C"></div>
<div id="id00B"></div>
<div class="panel-group" id="accordionMap">

  <div class="panel panel-default">
	<!-- remove the data-parent="#accordionMap" attribute so the accordion stops -->
    <div class="panel-heading btn-block" data-toggle="collapse" href="#collapseRoute">Pick Route</div>
	<div id="collapseRoute" class="panel-collapse collapse">
	  <div id="routePanel" class="panel-body">
		<div>
			<span id="selectRouteButton" class="active btn btn-default" onclick="selectRoute()">Route</span>
			<span id="selectedRoute"></span>
			<span id="selectDirectionButton"    class="btn btn-default" onclick="selectRouteDirectionsUsingMyRoute()">Direction</span>
			<span id="selectedDirection"></span>
			<span id="selectStopButton"         class="btn btn-default" onclick="selectRouteDirectionStopsUsingMyDirection()">Stop</span>
			<span id="selectedStop"></span>
		</div>
		<hr>
        <div id="id00RouteDirectionStop"></div>
	  </div>
	</div>
  </div>

  <div class="panel panel-default">
    <div class="panel-heading btn-block" data-toggle="collapse" data-parent="#accordionMap" href="#collapseBusStop">Bus Stop
	</div>
	<div id="collapseBusStop" class="panel-collapse collapse">
		<div class="panel-body">
			<form id="busStopForm" class="form-inline" action="">
				<div class="form-group">
					<label class="sr-only" for="stopNumber">Stop Number:</label>
					<input class="form-control input-sm" id="stopNumber" type="number" min="34" max="70101" name="stopNumber" placeholder="Stop #" required />
				</div>
				<div class="form-group">
					<label class="sr-only" for="stopDescription">Description:</label>
					<input class="form-control input-sm" id="stopDescription" type="text" name="stopDescription" placeholder="Enter Description"/>
				</div>
				<button type="submit">Submit</button>
			</form>
		</div>
		</form>
		<script>
		  "use strict";
		  var form = document.getElementById("busStopForm");
		  form.addEventListener("submit", function(event) {
			event.preventDefault();
			if(getDbValue("o34") == null) {
				loadNumberedBusStopData();
			}
			if(getDbValue("o" + form.elements.stopNumber.value) == null) {
				// show a validation error
				alert("stop number not found.");
				return;
			}
			
			console.log("Saving value", form.elements.stopNumber.value);
			//var newValue = "{\"stopNumber\":\"" + form.elements.stopNumber.value + "\"}";
			var newValue = '{"stopNumber":"' + form.elements.stopNumber.value + '", "description":"' + form.elements.stopDescription.value + '"}';
			setDbValue("BusStopNumber1", newValue);
			// alert("interrupted the 'Submit' event.  stopNumber=" + form.elements.stopNumber.value);
			showStop(form.elements.stopNumber.value);
		  });
		</script>
	</div>
  </div>

  <div class="panel panel-default">
	<!-- remove the data-parent="#accordionMap" attribute to see if accordion stops -->
    <div class="panel-heading btn-block" data-toggle="collapse" href="#collapseMap">Map</div>
	<div id="collapseMap" class="panel-collapse collapse">
	  <div id="map_button" class="panel-body-sm map-title"></div>
	  <div id="map_canvas" class="panel-body" style="width: 100%; height: 500px"></div>
	</div>
  </div>
  
</div>

<script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCsZ0T2Q9DZ5naamWI5WEyYEqWcbxPgCs0&callback=initializeMap" async defer></script>

<script type='text/javascript' src='stopLocations.js' defer="true"></script>
<script type='text/javascript' src='stopOffsets.js' defer="true"></script>

<script type="text/javascript">
"use strict";
// global variables for location
var Marquette400S    = {latitude:44.979001, longitude:-93.268623};   //133 

var SouthAndWestOfGatewayRamp  = {latitude:44.9779802, longitude:-93.2642134};   //133  waypoint before Marquette and 4th
var Washington300S     = {latitude:44.979682,  longitude:-93.264170};            // 133 bus is on the move
var SWofWashington300S = {latitude:44.979299,  longitude:-93.263962};
var GrantAnd35W        = {latitude:44.969878,  longitude:-93.269835};            //133  returning, still on 35W

var FourthStreet215S = {latitude:44.978416,  longitude:-93.266661};   // #7
var SixthStreet201S  = {latitude:44.9763315, longitude:-93.268188};   // #14
var Washington300N   = {latitude:44.984393,  longtiude:-93.272505};   // #14
var Washington500N   = {latitude:44.978711,  longitude:-93.262360};   // #14

var BroadwayEmerson  = {latitude:44.999164,  longitude:-93.294136};   // #14
var PlymouthWashington = {latitude:44.992010,longitude:-93.281476};   // #14
var FifthStBusRamp   = {latitude:44.980832,  longitude:-93.275425};   // #14
var SixthNicollet    = {latitude:44.977802,  longitude:-93.271305};

var myRoute = 14;
var myDirection = 1;
var myStop = '';

var myBlockNumber = 0;
var myBlockNumberTimeout = new Date(2015,1,1);

var isCurrentTargetANumberedBusStop = false;    //  numbered vs scheduled bus stop

if(Modernizr.localstorage) {
	var p =  getDbValue("RouteDirectionStopActive");
	if(p != null) {
		var rdsa = JSON.parse(p);
		getDepartures(rdsa.route, rdsa.direction, rdsa.stop);
	}
	
	resetRecentButtons();
}

</script>
</body>
</html> 